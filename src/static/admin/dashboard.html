<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Location Tracker</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #334e68;
            --accent-color: #47b881;
            --danger-color: #d64545;
            --light-color: #f5f7fa;
            --dark-color: #243b53;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            padding: 20px;
        }
        
        .sidebar-header {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .sidebar-nav {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 5px;
        }
        
        .sidebar-nav a {
            display: block;
            padding: 10px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: all 0.3s;
        }
        
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-footer a {
            display: block;
            padding: 10px;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .sidebar-footer a:hover {
            color: white;
        }
        
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header h2 {
            color: var(--secondary-color);
        }
        
        .refresh-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .refresh-button:hover {
            background-color: var(--secondary-color);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .stat-card h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .map-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        
        .map-container h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }
        
        .visitor-list {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .visitor-list h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .visitor-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .visitor-table th, .visitor-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .visitor-table th {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .visitor-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .visitor-details {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .chart-card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .chart-canvas {
            width: 100%;
            height: 250px;
        }
    </style>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Location Tracker</h1>
                <p>Admin Dashboard</p>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="active">Dashboard</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Reports</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="/admin/logout">Logout</a>
            </div>
        </div>
        <div class="main-content">
            <div class="header">
                <h2>Visitor Tracking Dashboard</h2>
                <button id="refresh-data" class="refresh-button">Refresh Data</button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Total Visitors</h3>
                    <div id="total-visitors" class="value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Today</h3>
                    <div id="active-today" class="value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Most Common Browser</h3>
                    <div id="common-browser" class="value">-</div>
                </div>
                <div class="stat-card">
                    <h3>Most Common OS</h3>
                    <div id="common-os" class="value">-</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-card">
                    <h3>Browser Distribution</h3>
                    <canvas id="browser-chart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Operating System Distribution</h3>
                    <canvas id="os-chart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="map-container">
                <h3>Visitor Locations</h3>
                <div id="map"></div>
            </div>
            
            <div class="visitor-list">
                <h3>Recent Visitors</h3>
                <table class="visitor-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>IP Address</th>
                            <th>Location</th>
                            <th>Browser/OS</th>
                            <th>First Seen</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody id="visitor-table-body">
                        <!-- Visitor data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([20, 0], 2);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Store markers by visitor ID
        const markers = {};
        
        // Charts
        let browserChart = null;
        let osChart = null;
        
        // Function to format date
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }
        
        // Function to update visitor table
        function updateVisitorTable(visitors) {
            const tableBody = document.getElementById('visitor-table-body');
            tableBody.innerHTML = '';
            
            visitors.forEach(visitor => {
                const row = document.createElement('tr');
                
                const idCell = document.createElement('td');
                idCell.textContent = visitor.id.substring(0, 8) + '...';
                row.appendChild(idCell);
                
                const ipCell = document.createElement('td');
                ipCell.textContent = visitor.location?.ip || 'Unknown';
                row.appendChild(ipCell);
                
                const locationCell = document.createElement('td');
                const locationText = visitor.location?.city 
                    ? `${visitor.location.city}, ${visitor.location.country || ''}`
                    : 'Unknown';
                locationCell.textContent = locationText;
                row.appendChild(locationCell);
                
                const browserCell = document.createElement('td');
                browserCell.textContent = `${visitor.browser || 'Unknown'} / ${visitor.os || 'Unknown'}`;
                row.appendChild(browserCell);
                
                const firstSeenCell = document.createElement('td');
                firstSeenCell.textContent = formatDate(visitor.first_seen);
                row.appendChild(firstSeenCell);
                
                const lastSeenCell = document.createElement('td');
                lastSeenCell.textContent = formatDate(visitor.last_seen);
                row.appendChild(lastSeenCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to update map markers
        function updateMapMarkers(visitors) {
            // Remove old markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            
            // Add new markers
            visitors.forEach(visitor => {
                if (visitor.location && visitor.location.loc) {
                    const [lat, lng] = visitor.location.loc.split(',').map(coord => parseFloat(coord.trim()));
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng]).addTo(map);
                        
                        // Create popup content
                        let popupContent = `
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 8px 0;">Visitor Details</h3>
                                <p><strong>IP:</strong> ${visitor.location.ip || 'Unknown'}</p>
                                <p><strong>Location:</strong> ${visitor.location.city || ''}, ${visitor.location.country || 'Unknown'}</p>
                                <p><strong>Browser:</strong> ${visitor.browser || 'Unknown'}</p>
                                <p><strong>OS:</strong> ${visitor.os || 'Unknown'}</p>
                                <p><strong>Device:</strong> ${visitor.device || 'Unknown'}</p>
                                <p><strong>First seen:</strong> ${formatDate(visitor.first_seen)}</p>
                                <p><strong>Last seen:</strong> ${formatDate(visitor.last_seen)}</p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        markers[visitor.id] = marker;
                    }
                }
            });
        }
        
        // Function to update statistics
        function updateStats(stats) {
            document.getElementById('total-visitors').textContent = stats.total_visitors;
            
            // Calculate active today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime() / 1000;
            
            let activeToday = 0;
            Object.values(stats.visitors || []).forEach(visitor => {
                if (visitor.last_seen >= todayTimestamp) {
                    activeToday++;
                }
            });
            
            document.getElementById('active-today').textContent = activeToday;
            
            // Find most common browser and OS
            let commonBrowser = '-';
            let maxBrowserCount = 0;
            Object.entries(stats.browser_stats || {}).forEach(([browser, count]) => {
                if (count > maxBrowserCount) {
                    maxBrowserCount = count;
                    commonBrowser = browser;
                }
            });
            
            let commonOS = '-';
            let maxOSCount = 0;
            Object.entries(stats.os_stats || {}).forEach(([os, count]) => {
                if (count > maxOSCount) {
                    maxOSCount = count;
                    commonOS = os;
                }
            });
            
            document.getElementById('common-browser').textContent = commonBrowser;
            document.getElementById('common-os').textContent = commonOS;
            
            // Update charts
            updateCharts(stats);
        }
        
        // Function to update charts
        function updateCharts(stats) {
            const browserCtx = document.getElementById('browser-chart').getContext('2d');
            const osCtx = document.getElementById('os-chart').getContext('2d');
            
            // Browser chart
            const browserLabels = Object.keys(stats.browser_stats || {});
            const browserData = Object.values(stats.browser_stats || {});
            
            if (browserChart) {
                browserChart.data.labels = browserLabels;
                browserChart.data.datasets[0].data = browserData;
                browserChart.update();
            } else {
                browserChart = new Chart(browserCtx, {
                    type: 'pie',
                    data: {
                        labels: browserLabels,
                        datasets: [{
                            data: browserData,
                            backgroundColor: [
                                '#4a6fa5', '#47b881', '#d64545', '#f59f00', '#9c36b5',
                                '#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // OS chart
            const osLabels = Object.keys(stats.os_stats || {});
            const osData = Object.values(stats.os_stats || {});
            
            if (osChart) {
                osChart.data.labels = osLabels;
                osChart.data.datasets[0].data = osData;
                osChart.update();
            } else {
                osChart = new Chart(osCtx, {
                    type: 'pie',
                    data: {
                        labels: osLabels,
                        datasets: [{
                            data: osData,
                            backgroundColor: [
                                '#47b881', '#4a6fa5', '#d64545', '#f59f00', '#9c36b5',
                                '#2ecc71', '#3498db', '#e74c3c', '#f1c40f', '#9b59b6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // Function to fetch and update all data
        function fetchData() {
            // Fetch visitor data
            fetch('/admin/api/visitors')
                .then(response => response.json())
                .then(visitors => {
                    updateVisitorTable(visitors);
                    updateMapMarkers(visitors);
                    
                    // Calculate stats from visitors
                    const stats = {
                        total_visitors: visitors.length,
                        visitors: visitors,
                        browser_stats: {},
                        os_stats: {}
                    };
                    
                    visitors.forEach(visitor => {
                        const browser = visitor.browser || 'Unknown';
                        const os = visitor.os || 'Unknown';
                        
                        stats.browser_stats[browser] = (stats.browser_stats[browser] || 0) + 1;
                        stats.os_stats[os] = (stats.os_stats[os] || 0) + 1;
                    });
                    
                    updateStats(stats);
                })
                .catch(error => console.error('Error fetching visitor data:', error));
        }
        
        // Initial data fetch
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            
            // Set up refresh button
            document.getElementById('refresh-data').addEventListener('click', fetchData);
            
            // Set up auto-refresh every 30 seconds
            setInterval(fetchData, 30000);
        });
    </script>
</body>
</html>
